[{"name":"app.R","content":"# app.R\r\ninstall.packages(c(\"shiny\", \"httr2\", \"jsonlite\", \"htmltools\", \"markdown\"))\r\nlibrary(shiny)\r\nlibrary(httr2)\r\nlibrary(jsonlite)\r\nlibrary(htmltools)\r\n\r\nTABLE_NAME <- \"Prod\"\r\n\r\n# ---------- Helpers ----------\r\nsb_headers <- function(sb_key) {\r\n  # For anon/public key, Supabase accepts apikey + Authorization Bearer\r\n  list(\r\n    apikey = sb_key,\r\n    Authorization = paste(\"Bearer\", sb_key),\r\n    \"Content-Type\" = \"application/json\"\r\n  )\r\n}\r\n\r\nsb_select_products <- function(sb_url, sb_key) {\r\n  req <- request(paste0(sb_url, \"/rest/v1/\", TABLE_NAME)) |>\r\n    req_headers(!!!sb_headers(sb_key)) |>\r\n    req_url_query(\r\n      select = \"product_id,name,base_price,category,images,final_price,discount_label\"\r\n    )\r\n  \r\n  resp <- req_perform(req)\r\n  if (resp_status(resp) >= 300) {\r\n    stop(\"Supabase select failed: \", resp_status(resp), \"\\n\", resp_body_string(resp))\r\n  }\r\n  \r\n  txt <- resp_body_string(resp)\r\n  if (!nzchar(txt)) return(list())\r\n  fromJSON(txt, simplifyVector = TRUE)\r\n}\r\n\r\nsb_update_product <- function(sb_url, sb_key, product_id, updates) {\r\n  req <- request(paste0(sb_url, \"/rest/v1/\", TABLE_NAME)) |>\r\n    req_headers(!!!sb_headers(sb_key)) |>\r\n    req_url_query(product_id = paste0(\"eq.\", product_id)) |>\r\n    req_method(\"PATCH\") |>\r\n    req_body_json(updates)\r\n  \r\n  resp <- req_perform(req)\r\n  if (resp_status(resp) >= 300) {\r\n    stop(\"Supabase update failed: \", resp_status(resp), \"\\n\", resp_body_string(resp))\r\n  }\r\n  invisible(TRUE)\r\n}\r\n\r\nget_weather <- function(city, ow_key) {\r\n  # Geocoding\r\n  geo_req <- request(\"https://api.openweathermap.org/geo/1.0/direct\") |>\r\n    req_url_query(q = city, limit = 1, appid = ow_key)\r\n  \r\n  geo_resp <- req_perform(geo_req)\r\n  if (resp_status(geo_resp) >= 300) {\r\n    stop(\"OpenWeather geo failed: \", resp_status(geo_resp), \"\\n\", resp_body_string(geo_resp))\r\n  }\r\n  \r\n  geo <- fromJSON(resp_body_string(geo_resp), simplifyVector = TRUE)\r\n  if (length(geo) == 0) return(NULL)\r\n  \r\n  lat <- geo$lat[1]\r\n  lon <- geo$lon[1]\r\n  loc <- geo$name[1]\r\n  \r\n  w_req <- request(\"https://api.openweathermap.org/data/2.5/weather\") |>\r\n    req_url_query(lat = lat, lon = lon, appid = ow_key, units = \"metric\")\r\n  \r\n  w_resp <- req_perform(w_req)\r\n  if (resp_status(w_resp) >= 300) {\r\n    stop(\"OpenWeather weather failed: \", resp_status(w_resp), \"\\n\", resp_body_string(w_resp))\r\n  }\r\n  \r\n  w <- fromJSON(resp_body_string(w_resp), simplifyVector = TRUE)\r\n  \r\n  list(\r\n    location_name = loc,\r\n    temp = w$main$temp,\r\n    condition = w$weather[[1]]$description,\r\n    icon_url = paste0(\"https://openweathermap.org/img/wn/\", w$weather[[1]]$icon, \"@2x.png\")\r\n  )\r\n}\r\n\r\nprice_for_row <- function(row, temp_c) {\r\n  base <- as.numeric(row$base_price)\r\n  cat <- tolower(trimws(ifelse(is.null(row$category) || is.na(row$category), \"\", row$category)))\r\n  \r\n  final <- base\r\n  label <- \"\"\r\n  \r\n  is_icecream <- grepl(\"ice\", cat) || gsub(\"_\", \" \", cat) == \"ice cream\"\r\n  \r\n  if (is_icecream) {\r\n    if (temp_c >= 30 && temp_c <= 35) {\r\n      final <- round(base * 0.70, 2)\r\n      label <- \"ðŸ¦ 30% OFF (30â€“35Â°C)\"\r\n    } else if (temp_c >= 25 && temp_c < 30) {\r\n      final <- round(base * 0.80, 2)\r\n      label <- \"ðŸ¦ 20% OFF (25â€“30Â°C)\"\r\n    }\r\n  } else if (cat == \"coffee\") {\r\n    if (temp_c >= 10 && temp_c < 20) {\r\n      final <- round(base * 0.70, 2)\r\n      label <- \"â˜• 30% OFF (10â€“20Â°C)\"\r\n    } else if (temp_c >= 20 && temp_c < 25) {\r\n      final <- round(base * 0.80, 2)\r\n      label <- \"â˜• 20% OFF (20â€“25Â°C)\"\r\n    }\r\n  } else if (cat == \"beer\") {\r\n    if (temp_c >= 30 && temp_c <= 35) {\r\n      final <- round(base * 0.70, 2)\r\n      label <- \"ðŸº 30% OFF (30â€“35Â°C)\"\r\n    } else if (temp_c >= 20 && temp_c < 25) {\r\n      final <- round(base * 0.90, 2)\r\n      label <- \"ðŸº 10% OFF (20â€“25Â°C)\"\r\n    }\r\n  } else if (cat == \"food\") {\r\n    if (temp_c >= 30 && temp_c <= 35) {\r\n      final <- round(base * 0.70, 2)\r\n      label <- \"ðŸ½ï¸ 30% OFF (30â€“35Â°C)\"\r\n    }\r\n  }\r\n  \r\n  list(final_price = final, discount_label = label)\r\n}\r\n\r\nmenu_cards_ui <- function(rows) {\r\n  if (length(rows) == 0) return(div())\r\n  \r\n  # rows might be a data.frame or list; normalize to list of rows\r\n  row_list <- if (is.data.frame(rows)) split(rows, seq_len(nrow(rows))) else rows\r\n  \r\n  div(\r\n    class = \"menu-grid\",\r\n    lapply(row_list, function(r) {\r\n      # r could be list with columns\r\n      name <- ifelse(is.null(r$name) || is.na(r$name), \"(unnamed product)\", r$name)\r\n      img  <- ifelse(is.null(r$images) || is.na(r$images) || !nzchar(trimws(r$images)),\r\n                     \"https://via.placeholder.com/400x260?text=No+Image\",\r\n                     trimws(r$images))\r\n      base <- as.numeric(r$base_price)\r\n      final <- ifelse(is.null(r$final_price) || is.na(r$final_price), base, as.numeric(r$final_price))\r\n      label <- ifelse(is.null(r$discount_label) || is.na(r$discount_label), \"\", r$discount_label)\r\n      \r\n      price_line <- tags$div(\r\n        tags$strong(paste0(\"â‚¹\", format(final, nsmall = 2))),\r\n        if (nzchar(label)) tags$span(\r\n          style = \"text-decoration: line-through; color:#4da3ff; margin-left:8px;\",\r\n          paste0(\"â‚¹\", format(base, nsmall = 2))\r\n        )\r\n      )\r\n      \r\n      div(\r\n        class = \"menu-card\",\r\n        tags$img(src = img, alt = \"product\", class = \"menu-img\"),\r\n        div(class = \"menu-name\", htmlEscape(name)),\r\n        div(class = \"menu-price\", price_line),\r\n        div(class = \"menu-discount\", label)\r\n      )\r\n    })\r\n  )\r\n}\r\n\r\n# ---------- UI ----------\r\nui <- fluidPage(\r\n  tags$head(\r\n    tags$style(HTML(\"\r\n      body { background:#070707; color:#fff; }\r\n      .panel { background:#0b0b0b; border:1px solid #222; border-radius:14px; padding:16px; }\r\n      .menu-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:18px; margin-top:16px; }\r\n      .menu-card { border:1px solid #222; background:#0b0b0b; border-radius:14px; padding:14px; text-align:center; }\r\n      .menu-img { width:100%; height:160px; object-fit:cover; border-radius:10px; margin-bottom:10px; }\r\n      .menu-name { font-weight:600; margin:6px 0 8px; }\r\n      .menu-price { font-size:15px; }\r\n      .menu-discount { color:#e63946; font-size:13px; margin-top:6px; min-height:18px; }\r\n      .btn-primary { border-radius:12px; }\r\n      .muted { color:#bdbdbd; }\r\n    \"))\r\n  ),\r\n  \r\n  titlePanel(\"ðŸ½ï¸ Smart Restaurant â€” Dynamic Menu Pricing (Shiny / shinylive)\"),\r\n  \r\n  fluidRow(\r\n    column(\r\n      6,\r\n      div(\r\n        class = \"panel\",\r\n        tags$p(class=\"muted\",\r\n               \"Enter your keys/URL below, then choose a city to fetch weather, update prices in Supabase, and display the live menu with images.\"\r\n        ),\r\n        passwordInput(\"ow_key\", \"OpenWeather API Key\", placeholder = \"Paste your OpenWeather API key\"),\r\n        textInput(\"sb_url\", \"Supabase URL\", placeholder = \"https://xxxxxxxx.supabase.co\"),\r\n        passwordInput(\"sb_anon\", \"Supabase Anon Key\", placeholder = \"Paste your anon/public key\"),\r\n        textInput(\"city\", \"ðŸ“ Enter City\", placeholder = \"e.g., Mumbai, Delhi, London\"),\r\n        actionButton(\"run\", \"Check Weather & Update Menu\", class = \"btn btn-primary\")\r\n      )\r\n    ),\r\n    column(\r\n      6,\r\n      div(\r\n        class = \"panel\",\r\n        uiOutput(\"weather_block\")\r\n      )\r\n    )\r\n  ),\r\n  \r\n  div(class=\"panel\", uiOutput(\"menu\"))\r\n)\r\n\r\n# ---------- Server ----------\r\nserver <- function(input, output, session) {\r\n  \r\n  state <- reactiveValues(\r\n    status = NULL,\r\n    weather = NULL,\r\n    rows = list()\r\n  )\r\n  \r\n  observeEvent(input$run, {\r\n    state$status <- NULL\r\n    state$weather <- NULL\r\n    state$rows <- list()\r\n    \r\n    # Validate\r\n    missing <- c()\r\n    if (!nzchar(input$ow_key)) missing <- c(missing, \"OpenWeather API Key\")\r\n    if (!nzchar(input$sb_url)) missing <- c(missing, \"Supabase URL\")\r\n    if (!nzchar(input$sb_anon)) missing <- c(missing, \"Supabase Anon Key\")\r\n    if (!nzchar(input$city)) missing <- c(missing, \"City\")\r\n    \r\n    if (length(missing) > 0) {\r\n      state$status <- paste(\"âŒ Missing:\", paste(missing, collapse = \", \"))\r\n      return()\r\n    }\r\n    \r\n    tryCatch({\r\n      w <- get_weather(input$city, input$ow_key)\r\n      if (is.null(w)) {\r\n        state$status <- paste0(\"âŒ City '\", input$city, \"' not found.\")\r\n        return()\r\n      }\r\n      \r\n      rows <- sb_select_products(input$sb_url, input$sb_anon)\r\n      count <- if (is.data.frame(rows)) nrow(rows) else length(rows)\r\n      \r\n      if (count == 0) {\r\n        state$weather <- w\r\n        state$status <- \"**Fetched 0 product(s) from `Prod`.**\"\r\n        state$rows <- list()\r\n        return()\r\n      }\r\n      \r\n      temp <- w$temp\r\n      cond <- w$condition\r\n      now_iso <- format(Sys.time(), \"%Y-%m-%dT%H:%M:%SZ\", tz = \"UTC\")\r\n      \r\n      any_discount <- FALSE\r\n      \r\n      # Update each row in Supabase\r\n      if (is.data.frame(rows)) {\r\n        for (i in seq_len(nrow(rows))) {\r\n          r <- rows[i, , drop = FALSE]\r\n          pr <- price_for_row(r, temp)\r\n          if (nzchar(pr$discount_label)) any_discount <- TRUE\r\n          \r\n          updates <- list(\r\n            final_price = pr$final_price,\r\n            discount_label = pr$discount_label,\r\n            last_weather_temp = temp,\r\n            last_weather_condition = cond,\r\n            last_city = w$location_name,\r\n            last_updated_at = now_iso\r\n          )\r\n          \r\n          ok <- TRUE\r\n          tryCatch({\r\n            sb_update_product(input$sb_url, input$sb_anon, r$product_id[[1]], updates)\r\n          }, error = function(e) {\r\n            ok <<- FALSE\r\n          })\r\n          \r\n          # Reflect in UI (and mark save failure)\r\n          rows$final_price[i] <- pr$final_price\r\n          rows$discount_label[i] <- if (!ok && nzchar(pr$discount_label)) {\r\n            paste(\"(âš ï¸ save failed)\", pr$discount_label)\r\n          } else if (!ok) {\r\n            \"(âš ï¸ save failed)\"\r\n          } else {\r\n            pr$discount_label\r\n          }\r\n        }\r\n      }\r\n      \r\n      state$weather <- w\r\n      state$status <- paste0(\"**Fetched \", count, \" product(s) from `Prod`.**\",\r\n                             \"\\n\\n- **Dynamic Pricing Active**: \", ifelse(any_discount, \"Yes\", \"No\"))\r\n      state$rows <- rows\r\n      \r\n    }, error = function(e) {\r\n      state$status <- paste0(\"âŒ Error: \", conditionMessage(e))\r\n    })\r\n  })\r\n  \r\n  output$weather_block <- renderUI({\r\n    if (!is.null(state$status) && is.null(state$weather)) {\r\n      return(div(state$status))\r\n    }\r\n    \r\n    w <- state$weather\r\n    if (is.null(w)) {\r\n      return(div(class=\"muted\", \"ðŸŒ¤ï¸ Weather info will appear hereâ€¦\"))\r\n    }\r\n    \r\n    div(\r\n      tags$h3(paste0(\"ðŸŒ¤ï¸ Weather in \", w$location_name)),\r\n      tags$ul(\r\n        tags$li(strong(\"Temperature: \"), paste0(w$temp, \"Â°C\")),\r\n        tags$li(strong(\"Condition: \"), tools::toTitleCase(w$condition))\r\n      ),\r\n      tags$img(src = w$icon_url, width = 80, height = 80),\r\n      tags$hr(),\r\n      div(HTML(markdown::markdownToHTML(text = state$status, fragment.only = TRUE)))\r\n    )\r\n  })\r\n  \r\n  output$menu <- renderUI({\r\n    if (is.null(state$weather) && is.null(state$status)) {\r\n      return(div(class=\"muted\", \"ðŸ½ï¸ Todayâ€™s Dynamic Menu will appear hereâ€¦\"))\r\n    }\r\n    menu_cards_ui(state$rows)\r\n  })\r\n}\r\n\r\nshinyApp(ui, server)\r\n","type":"text"},{"name":"Dynamic_Pricing_shinylive.Rproj","content":"Version: 1.0\r\n\r\nRestoreWorkspace: Default\r\nSaveWorkspace: Default\r\nAlwaysSaveHistory: Default\r\n\r\nEnableCodeIndexing: Yes\r\nUseSpacesForTab: Yes\r\nNumSpacesForTab: 2\r\nEncoding: UTF-8\r\n\r\nRnwWeave: Sweave\r\nLaTeX: pdfLaTeX\r\n","type":"text"}]
