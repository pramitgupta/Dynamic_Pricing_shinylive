[{"name":"app.R","content":"library(shiny)\r\nlibrary(htmltools)\r\n\r\n`%||%` <- function(a, b) if (!is.null(a)) a else b\r\n\r\n# ---------------- Pricing rules ----------------\r\nprice_for_row <- function(row, temp_c) {\r\n  base <- as.numeric(row$base_price)\r\n  cat  <- tolower(trimws((row$category %||% \"\")))\r\n  \r\n  final <- base\r\n  label <- \"\"\r\n  \r\n  is_icecream <- grepl(\"ice\", cat) || gsub(\"_\", \" \", cat) == \"ice cream\"\r\n  \r\n  if (is_icecream) {\r\n    if (temp_c >= 30 && temp_c <= 35) {\r\n      final <- round(base * 0.70, 2)\r\n      label <- \"ðŸ¦ 30% OFF (30â€“35Â°C)\"\r\n    } else if (temp_c >= 25 && temp_c < 30) {\r\n      final <- round(base * 0.80, 2)\r\n      label <- \"ðŸ¦ 20% OFF (25â€“30Â°C)\"\r\n    }\r\n  } else if (cat == \"coffee\") {\r\n    if (temp_c >= 10 && temp_c < 20) {\r\n      final <- round(base * 0.70, 2)\r\n      label <- \"â˜• 30% OFF (10â€“20Â°C)\"\r\n    } else if (temp_c >= 20 && temp_c < 25) {\r\n      final <- round(base * 0.80, 2)\r\n      label <- \"â˜• 20% OFF (20â€“25Â°C)\"\r\n    }\r\n  } else if (cat == \"beer\") {\r\n    if (temp_c >= 30 && temp_c <= 35) {\r\n      final <- round(base * 0.70, 2)\r\n      label <- \"ðŸº 30% OFF (30â€“35Â°C)\"\r\n    } else if (temp_c >= 20 && temp_c < 25) {\r\n      final <- round(base * 0.90, 2)\r\n      label <- \"ðŸº 10% OFF (20â€“25Â°C)\"\r\n    }\r\n  } else if (cat == \"food\") {\r\n    if (temp_c >= 30 && temp_c <= 35) {\r\n      final <- round(base * 0.70, 2)\r\n      label <- \"ðŸ½ï¸ 30% OFF (30â€“35Â°C)\"\r\n    }\r\n  }\r\n  \r\n  list(final_price = final, discount_label = label)\r\n}\r\n\r\nmenu_cards_ui <- function(rows) {\r\n  if (is.null(rows) || length(rows) == 0) {\r\n    return(div(class = \"muted\", \"No products to show.\"))\r\n  }\r\n  \r\n  div(\r\n    class = \"menu-grid\",\r\n    lapply(rows, function(r) {\r\n      name  <- (r$name %||% \"(unnamed product)\")\r\n      img   <- (r$images %||% \"\")\r\n      img   <- if (!nzchar(trimws(img))) \"https://via.placeholder.com/400x260?text=No+Image\" else trimws(img)\r\n      \r\n      base  <- as.numeric(r$base_price)\r\n      final <- as.numeric(r$final_price %||% base)\r\n      label <- (r$discount_label %||% \"\")\r\n      \r\n      div(\r\n        class = \"menu-card\",\r\n        tags$img(src = img, alt = \"product\", class = \"menu-img\"),\r\n        div(class = \"menu-name\", htmlEscape(name)),\r\n        div(\r\n          class = \"menu-price\",\r\n          tags$strong(sprintf(\"â‚¹%.2f\", final)),\r\n          if (nzchar(label)) tags$span(\r\n            style = \"text-decoration: line-through; color:#4da3ff; margin-left:8px;\",\r\n            sprintf(\"â‚¹%.2f\", base)\r\n          )\r\n        ),\r\n        div(class = \"menu-discount\", label)\r\n      )\r\n    })\r\n  )\r\n}\r\n\r\n# ---------------- UI ----------------\r\nui <- fluidPage(\r\n  tags$head(\r\n    tags$style(HTML(\"\r\n      body { background:#070707; color:#fff; }\r\n      .panel { background:#0b0b0b; border:1px solid #222; border-radius:14px; padding:16px; margin-bottom:14px;}\r\n      .menu-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:18px; margin-top:16px; }\r\n      .menu-card { border:1px solid #222; background:#0b0b0b; border-radius:14px; padding:14px; text-align:center; }\r\n      .menu-img { width:100%; height:160px; object-fit:cover; border-radius:10px; margin-bottom:10px; }\r\n      .menu-name { font-weight:600; margin:6px 0 8px; }\r\n      .menu-price { font-size:15px; }\r\n      .menu-discount { color:#e63946; font-size:13px; margin-top:6px; min-height:18px; }\r\n      .muted { color:#bdbdbd; }\r\n      .ok { color:#7CFC98; }\r\n      .bad { color:#ff6b6b; }\r\n    \")),\r\n    tags$script(HTML(\"\r\n      (function(){\r\n        function el(id){ return document.getElementById(id); }\r\n\r\n        async function fetchJSON(url, opts){\r\n          const res = await fetch(url, opts);\r\n          const txt = await res.text();\r\n          let data = null;\r\n          try { data = txt ? JSON.parse(txt) : null; } catch(e) {}\r\n          if(!res.ok){\r\n            throw new Error((data && (data.message || data.error)) ? (data.message || data.error) : (txt || ('HTTP ' + res.status)));\r\n          }\r\n          return data;\r\n        }\r\n\r\n        async function runFetch(){\r\n          const ow = (el('ow_key')?.value || '').trim();\r\n          const sbUrlRaw = (el('sb_url')?.value || '').trim();\r\n          const sbUrl = sbUrlRaw.replace(/\\\\/$/, '');\r\n          const sbKey = (el('sb_anon')?.value || '').trim();\r\n          const city = (el('city')?.value || '').trim();\r\n\r\n          const missing = [];\r\n          if(!ow) missing.push('OpenWeather API Key');\r\n          if(!sbUrl) missing.push('Supabase URL');\r\n          if(!sbKey) missing.push('Supabase Anon Key');\r\n          if(!city) missing.push('City');\r\n\r\n          if(missing.length){\r\n            Shiny.setInputValue('js_error', 'âŒ Missing: ' + missing.join(', '), {priority:'event'});\r\n            return;\r\n          }\r\n\r\n          Shiny.setInputValue('js_error', '', {priority:'event'});\r\n          Shiny.setInputValue('js_status', 'Fetching weather + productsâ€¦', {priority:'event'});\r\n\r\n          try{\r\n            const geo = await fetchJSON(\r\n              'https://api.openweathermap.org/geo/1.0/direct?q=' + encodeURIComponent(city) + '&limit=1&appid=' + encodeURIComponent(ow)\r\n            );\r\n\r\n            if(!geo || !geo.length){\r\n              Shiny.setInputValue('js_error', `âŒ City '${city}' not found.`, {priority:'event'});\r\n              Shiny.setInputValue('js_status', '', {priority:'event'});\r\n              return;\r\n            }\r\n\r\n            const lat = geo[0].lat, lon = geo[0].lon;\r\n            const loc = geo[0].name;\r\n\r\n            const w = await fetchJSON(\r\n              'https://api.openweathermap.org/data/2.5/weather?lat=' + lat + '&lon=' + lon + '&units=metric&appid=' + encodeURIComponent(ow)\r\n            );\r\n\r\n            const weather = {\r\n              location_name: loc,\r\n              temp: w.main.temp,\r\n              condition: w.weather[0].description,\r\n              icon_url: 'https://openweathermap.org/img/wn/' + w.weather[0].icon + '@2x.png'\r\n            };\r\n\r\n            const selectUrl = sbUrl + '/rest/v1/Prod?select=' + encodeURIComponent('product_id,name,base_price,category,images,final_price,discount_label');\r\n\r\n            const rows = await fetchJSON(selectUrl, {\r\n              headers: {\r\n                'apikey': sbKey,\r\n                'Authorization': 'Bearer ' + sbKey,\r\n                'Content-Type': 'application/json'\r\n              }\r\n            });\r\n\r\n            Shiny.setInputValue('js_payload', { sbUrl, sbKey, weather, rows }, {priority:'event'});\r\n          } catch(err){\r\n            Shiny.setInputValue('js_error', 'âŒ Error: ' + err.message, {priority:'event'});\r\n          } finally {\r\n            Shiny.setInputValue('js_status', '', {priority:'event'});\r\n          }\r\n        }\r\n\r\n        document.addEventListener('DOMContentLoaded', function(){\r\n          const btn = el('run');\r\n          if(btn){\r\n            btn.addEventListener('click', function(){\r\n              runFetch();\r\n            });\r\n          }\r\n        });\r\n\r\n        Shiny.addCustomMessageHandler('applyUpdates', async function(msg){\r\n          const sbUrl = msg.sbUrl;\r\n          const sbKey = msg.sbKey;\r\n          const updates = msg.updates || [];\r\n\r\n          let ok = 0, fail = 0;\r\n\r\n          for(const u of updates){\r\n            const patchUrl = sbUrl + '/rest/v1/Prod?product_id=eq.' + encodeURIComponent(u.product_id);\r\n\r\n            try{\r\n              await fetchJSON(patchUrl, {\r\n                method: 'PATCH',\r\n                headers: {\r\n                  'apikey': sbKey,\r\n                  'Authorization': 'Bearer ' + sbKey,\r\n                  'Content-Type': 'application/json',\r\n                  'Prefer': 'return=minimal'\r\n                },\r\n                body: JSON.stringify(u.fields)\r\n              });\r\n              ok++;\r\n            } catch(e){\r\n              fail++;\r\n            }\r\n          }\r\n\r\n          Shiny.setInputValue('js_save_result', {ok, fail, total: updates.length}, {priority:'event'});\r\n        });\r\n      })();\r\n    \"))\r\n  ),\r\n  \r\n  titlePanel(\"ðŸ½ï¸ Smart Restaurant â€” shinylive (JS fetch + R pricing)\"),\r\n  \r\n  div(\r\n    class = \"panel\",\r\n    tags$p(class = \"muted\",\r\n           \"Note: On shinylive/GitHub Pages, API keys are visible to users (client-side). Use for demos only.\"\r\n    ),\r\n    fluidRow(\r\n      column(4, passwordInput(\"ow_key\", \"OpenWeather API Key\")),\r\n      column(4, textInput(\"sb_url\", \"Supabase URL\", placeholder = \"https://xxxx.supabase.co\")),\r\n      column(4, passwordInput(\"sb_anon\", \"Supabase Anon Key\"))\r\n    ),\r\n    fluidRow(\r\n      column(8, textInput(\"city\", \"ðŸ“ City\", placeholder = \"e.g., Mumbai\")),\r\n      column(4, br(), actionButton(\"run\", \"Check Weather & Update Menu\", class = \"btn btn-primary\"))\r\n    ),\r\n    uiOutput(\"msg_block\")\r\n  ),\r\n  \r\n  div(class = \"panel\", uiOutput(\"weather_block\")),\r\n  div(class = \"panel\", uiOutput(\"menu_block\"))\r\n)\r\n\r\n# ---------------- Server ----------------\r\nserver <- function(input, output, session) {\r\n  \r\n  state <- reactiveValues(\r\n    weather = NULL,\r\n    rows = NULL,\r\n    sbUrl = NULL,\r\n    sbKey = NULL,\r\n    error = \"\",\r\n    status = \"\",\r\n    save = NULL\r\n  )\r\n  \r\n  observeEvent(input$js_error, {\r\n    state$error <- input$js_error %||% \"\"\r\n  }, ignoreNULL = FALSE)\r\n  \r\n  observeEvent(input$js_status, {\r\n    state$status <- input$js_status %||% \"\"\r\n  }, ignoreNULL = FALSE)\r\n  \r\n  observeEvent(input$js_payload, {\r\n    p <- input$js_payload\r\n    if (is.null(p)) return()\r\n    \r\n    state$sbUrl   <- p$sbUrl\r\n    state$sbKey   <- p$sbKey\r\n    state$weather <- p$weather\r\n    state$rows    <- p$rows\r\n    state$save    <- NULL\r\n    \r\n    if (is.null(state$rows) || length(state$rows) == 0) return()\r\n    \r\n    temp <- as.numeric(state$weather$temp)\r\n    cond <- state$weather$condition\r\n    now_iso <- format(Sys.time(), \"%Y-%m-%dT%H:%M:%SZ\", tz = \"UTC\")\r\n    \r\n    updates <- list()\r\n    \r\n    for (i in seq_along(state$rows)) {\r\n      r  <- state$rows[[i]]\r\n      pr <- price_for_row(r, temp)\r\n      \r\n      # update UI state\r\n      state$rows[[i]]$final_price    <- pr$final_price\r\n      state$rows[[i]]$discount_label <- pr$discount_label\r\n      \r\n      updates[[length(updates) + 1]] <- list(\r\n        product_id = r$product_id,\r\n        fields = list(\r\n          final_price = pr$final_price,\r\n          discount_label = pr$discount_label,\r\n          last_weather_temp = temp,\r\n          last_weather_condition = cond,\r\n          last_city = state$weather$location_name,\r\n          last_updated_at = now_iso\r\n        )\r\n      )\r\n    }\r\n    \r\n    session$sendCustomMessage(\"applyUpdates\", list(\r\n      sbUrl = state$sbUrl,\r\n      sbKey = state$sbKey,\r\n      updates = updates\r\n    ))\r\n  })\r\n  \r\n  observeEvent(input$js_save_result, {\r\n    state$save <- input$js_save_result\r\n  })\r\n  \r\n  output$msg_block <- renderUI({\r\n    div(\r\n      if (nzchar(state$error)) div(class = \"bad\", state$error),\r\n      if (nzchar(state$status)) div(class = \"muted\", state$status),\r\n      if (!is.null(state$save)) {\r\n        if (state$save$fail == 0) {\r\n          div(class = \"ok\", sprintf(\"âœ… Saved %d/%d updates to Supabase.\", state$save$ok, state$save$total))\r\n        } else {\r\n          div(class = \"bad\", sprintf(\"âš ï¸ Saved %d/%d updates. Failed: %d.\", state$save$ok, state$save$total, state$save$fail))\r\n        }\r\n      }\r\n    )\r\n  })\r\n  \r\n  output$weather_block <- renderUI({\r\n    w <- state$weather\r\n    if (is.null(w)) return(div(class = \"muted\", \"ðŸŒ¤ï¸ Weather info will appear hereâ€¦\"))\r\n    \r\n    div(\r\n      tags$h3(paste0(\"ðŸŒ¤ï¸ Weather in \", w$location_name)),\r\n      tags$ul(\r\n        tags$li(tags$strong(\"Temperature: \"), paste0(w$temp, \"Â°C\")),\r\n        tags$li(tags$strong(\"Condition: \"), tools::toTitleCase(w$condition))\r\n      ),\r\n      tags$img(src = w$icon_url, width = 80, height = 80)\r\n    )\r\n  })\r\n  \r\n  output$menu_block <- renderUI({\r\n    if (is.null(state$rows)) return(div(class = \"muted\", \"ðŸ½ï¸ Menu will appear hereâ€¦\"))\r\n    menu_cards_ui(state$rows)\r\n  })\r\n}\r\n\r\nshinyApp(ui, server)\r\n","type":"text"},{"name":"Dynamic_Pricing_shinylive.Rproj","content":"Version: 1.0\r\n\r\nRestoreWorkspace: Default\r\nSaveWorkspace: Default\r\nAlwaysSaveHistory: Default\r\n\r\nEnableCodeIndexing: Yes\r\nUseSpacesForTab: Yes\r\nNumSpacesForTab: 2\r\nEncoding: UTF-8\r\n\r\nRnwWeave: Sweave\r\nLaTeX: pdfLaTeX\r\n","type":"text"}]
